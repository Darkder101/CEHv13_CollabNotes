# IP Protocol Ping Scan

## Definition

IP Protocol Ping Scan is a host discovery technique that sends IP packets with different protocol numbers in the IP header to determine if a target host is alive and which IP protocols are supported. Unlike traditional ping methods that use specific protocols (ICMP, TCP, UDP), this technique systematically tests various IP protocols to identify live hosts and gather information about protocol support on target systems.

## How IP Protocol Ping Scan Works

### Basic Process:
1. **Source Host** sends IP packets with different protocol numbers
2. **Target Host** receives packets for various protocols
3. **Target Host** processes packets based on protocol support
4. **Target Host** responds with ICMP Protocol Unreachable if unsupported
5. **Source Host** analyzes responses to determine host status and protocol support
6. **Mapping**: Build protocol support map for discovered hosts

### Packet Structure:
- **IP Header**: Source/destination IPs, Protocol field (varying values)
- **Protocol Number**: Identifies the next-level protocol (1=ICMP, 6=TCP, 17=UDP)
- **Payload**: Minimal or empty payload for testing
- **Response Analysis**: ICMP errors or protocol-specific responses

## IP Protocol Numbers

| Protocol | Number | Description |
|----------|--------|-------------|
| ICMP | 1 | Internet Control Message Protocol |
| IGMP | 2 | Internet Group Management Protocol |
| TCP | 6 | Transmission Control Protocol |
| UDP | 17 | User Datagram Protocol |
| GRE | 47 | Generic Routing Encapsulation |
| ESP | 50 | Encapsulating Security Protocol |
| AH | 51 | Authentication Header |
| ICMPv6 | 58 | Internet Control Message Protocol v6 |
| OSPF | 89 | Open Shortest Path First |
| SCTP | 132 | Stream Control Transmission Protocol |

## Tools and Commands

### Nmap IP Protocol Ping
```bash
# Default IP protocol ping
nmap -PO target_ip

# Specific protocol numbers
nmap -PO1,2,4 192.168.1.1

# Protocol ping with common protocols
nmap -PO1,6,17,47 192.168.1.1

# Protocol ping for IP range
nmap -sn -PO1,6,17 192.168.1.0/24

# Combined protocol ping
nmap -sn -PE -PO1,6,17 192.168.1.1

# Verbose protocol ping scan
nmap -sn -PO1,6,17 -v 192.168.1.0/24
```

### Hping3 Protocol Testing
```bash
# Send ICMP protocol packet
hping3 --icmp target_ip

# Send raw IP packet with protocol
hping3 --rawip --ipproto 47 target_ip

# Test multiple protocols
for proto in 1 6 17 47; do hping3 --rawip --ipproto $proto target_ip; done
```

### Raw Socket Programming
```bash
# Test protocol support with specific tools
# ICMP (Protocol 1)
ping target_ip

# TCP (Protocol 6) 
nmap -sS target_ip

# UDP (Protocol 17)
nmap -sU target_ip
```

## Response Analysis

### Supported Protocol Responses:
- **Protocol-Specific**: Normal protocol response (TCP RST, UDP response)
- **No ICMP Error**: Protocol supported but no service listening
- **Service Response**: Application-level response from protocol handler
- **Host Alive**: Confirms host is reachable and processing packets

### Unsupported Protocol Responses:
- **ICMP Protocol Unreachable**: Protocol not supported by target
- **Type 3, Code 2**: Destination Unreachable - Protocol Unreachable
- **Immediate Response**: Usually generated by network stack
- **Information Disclosure**: Reveals protocol support capabilities

### Filtered Responses:
- **No Response**: Firewall dropping packets silently
- **ICMP Filtered**: Firewall sending unreachable messages
- **Timeout**: Packet lost or blocked without response
- **Inconsistent**: Different responses for different protocols

## Advantages

- **Host Discovery**: Alternative method when other pings fail
- **Protocol Enumeration**: Discovers supported IP protocols
- **Firewall Evasion**: May bypass protocol-specific filtering
- **Network Intelligence**: Reveals network device capabilities
- **Rare Technique**: Less commonly monitored by security systems
- **Comprehensive**: Tests multiple protocols simultaneously

## Limitations

- **Limited Effectiveness**: Many firewalls block uncommon protocols
- **False Negatives**: Protocol support doesn't guarantee host discovery
- **Implementation Issues**: Not all systems properly handle protocol testing
- **Slow Scanning**: Testing multiple protocols increases scan time
- **Detection Risk**: Unusual protocol usage may trigger alerts
- **Platform Dependency**: Different OS handling of protocol packets

## System Response Behaviors

### Modern Operating Systems:
- **Windows**: Supports common protocols, may drop unusual ones
- **Linux**: Configurable protocol support through kernel modules
- **Unix**: Varies by implementation and configuration
- **Network Devices**: Protocol support based on device function

### Network Infrastructure:
- **Routers**: Support routing protocols (OSPF, EIGRP) and common protocols
- **Firewalls**: May filter based on protocol policies
- **Switches**: Layer 2 devices forward most IP protocols
- **Load Balancers**: Protocol support varies by configuration

### Service-Specific Responses:
- **VPN Gateways**: Support IPSec protocols (ESP, AH)
- **Tunneling Devices**: GRE and other tunneling protocol support
- **Multicast Routers**: IGMP protocol support
- **Specialized Appliances**: Custom protocol implementations

## Security Implications

### Information Disclosure:
- **Protocol Fingerprinting**: Identifies device types and capabilities
- **Service Discovery**: Reveals specialized network services
- **Network Architecture**: Exposes network infrastructure details
- **Vulnerability Assessment**: Protocol-specific security issues

### For Attackers:
- **Reconnaissance**: Gather detailed network protocol information
- **Attack Surface**: Identify supported protocols for exploitation
- **Evasion Techniques**: Use uncommon protocols to bypass detection
- **Network Mapping**: Build comprehensive protocol support maps

### For Defenders:
- **Protocol Filtering**: Implement strict protocol-based filtering
- **Monitoring**: Watch for unusual protocol usage patterns
- **Configuration**: Disable unnecessary protocol support
- **Detection**: Monitor for protocol enumeration attempts

## Detection and Response

### Detection Methods:
- **Protocol Monitoring**: Watch for unusual protocol combinations
- **Pattern Analysis**: Multiple protocol tests from single source
- **Error Analysis**: High volume of ICMP Protocol Unreachable messages
- **Behavioral Detection**: Scanning patterns across protocol numbers

### Response Patterns:
```
# Supported Protocol
IP Protocol 6 (TCP) to 192.168.1.1
Response: TCP RST or normal TCP response
Protocol supported, host alive

# Unsupported Protocol
IP Protocol 89 (OSPF) to 192.168.1.1
Response: ICMP Protocol Unreachable (Type 3, Code 2)
Protocol not supported, host alive

# Filtered Protocol
IP Protocol 47 (GRE) to 192.168.1.1
No response received
Likely filtered by firewall
```

## Protocol-Specific Considerations

### Common Protocol Testing:
- **ICMP (1)**: Basic connectivity testing
- **TCP (6)**: Connection-oriented service testing
- **UDP (17)**: Connectionless service testing
- **GRE (47)**: Tunneling capability detection

### Specialized Protocol Testing:
- **IPSec Protocols**: ESP (50), AH (51) for VPN detection
- **Routing Protocols**: OSPF (89) for router identification  
- **Multicast**: IGMP (2) for multicast capability
- **SCTP (132)**: Advanced transport protocol support

### Security Protocol Analysis:
- **ESP/AH Support**: Indicates IPSec capability
- **Protocol Combinations**: Multiple security protocols suggest VPN gateway
- **Custom Protocols**: Proprietary implementations may use reserved numbers
- **Legacy Support**: Older protocol support may indicate legacy systems

## Practical Applications

### Network Discovery:
- **Device Identification**: Identify device types by protocol support
- **Service Mapping**: Discover specialized network services  
- **Infrastructure Analysis**: Map network architecture and capabilities
- **Security Assessment**: Evaluate protocol-based security controls

### Security Testing:
- **Firewall Testing**: Verify protocol filtering effectiveness
- **Protocol Enumeration**: Discover supported communication protocols
- **Evasion Testing**: Test detection capabilities with unusual protocols
- **Vulnerability Research**: Identify protocol-specific security issues

## CEH Exam Focus Points

- Understand IP protocol numbers and their purposes
- Know common protocols: ICMP (1), TCP (6), UDP (17), GRE (47)
- Recognize ICMP Protocol Unreachable (Type 3, Code 2) responses
- Understand when protocol ping is useful for host discovery
- Be familiar with Nmap -PO option and protocol specification
- Know how protocol support reveals device capabilities
- Understand security implications of protocol enumeration
- Recognize detection methods for IP protocol scanning
