# Fragmentation Attacks

## ðŸ“ Attack Classification
- **Category**: Resource Exhaustion / Protocol Exploitation
- **OSI Layer**: Layer 3 (Network) / Layer 4 (Transport)
- **Protocol**: IP (IPv4/IPv6)
- **Variants**: Teardrop, Ping of Death, Overlapping Fragments

## ðŸŽ¯ Attack Mechanism
Exploits **IP fragmentation reassembly** process by sending malformed, overlapping, or excessive fragments to crash systems or consume resources.

### How it Works:
1. **Fragment Creation**: Split packets into multiple fragments
2. **Malformation**: Create invalid fragment combinations
3. **Resource Exhaustion**: Overwhelm reassembly buffers
4. **System Crash**: Cause buffer overflows or logic errors

## ðŸ” Key Characteristics
- **IP Fragmentation**: Exploits packet splitting mechanism
- **Memory Exhaustion**: Fills fragment reassembly tables
- **Malformed Headers**: Invalid offset/flag combinations
- **Buffer Overflows**: Can trigger system crashes

## ðŸš¨ Exam Focus Points

### Critical Numbers:
- **Max IP Packet Size**: 65,535 bytes
- **Fragment Offset**: 13-bit field (8-byte units)
- **Fragment ID**: 16-bit identification field
- **MTU Size**: Typically 1500 bytes (Ethernet)

### Common Exam Questions:
- **Q**: What field determines fragment reassembly order?
- **A**: Fragment Offset field in IP header
- **Q**: Which attack uses overlapping fragments with different data?
- **A**: Teardrop attack
- **Q**: What happens when fragment reassembly times out?
- **A**: Fragments are discarded, consuming resources

### Attack Components:
- **Fragment ID**: Groups related fragments
- **Fragment Offset**: Position in original packet
- **More Fragments (MF)**: Flag indicating more fragments
- **Don't Fragment (DF)**: Flag preventing fragmentation

## âš¡ Attack Variations

### Teardrop Attack:
- **Method**: Overlapping fragments with conflicting data
- **Impact**: Buffer overflow, system crash
- **Target**: Fragment reassembly logic

### Ping of Death:
- **Method**: Fragments that reassemble to >65535 bytes
- **Impact**: Buffer overflow in IP stack
- **Historical**: Affected many systems in 1990s

### Fragment Flooding:
- **Method**: Send excessive incomplete fragment sets
- **Impact**: Memory exhaustion
- **Modern**: Still effective against resource-limited devices

### Overlapping Fragments:
- **Method**: Fragments with overlapping byte ranges
- **Impact**: Undefined reassembly behavior
- **Exploitation**: Firewall/IDS evasion

## ðŸ›¡ï¸ Detection & Mitigation
- **Network Protection**:
  - Fragment reassembly timeout tuning
  - Maximum fragment queue limits
  - Drop incomplete fragment sets
  - Fragment overlap detection

- **Firewall Rules**:
  - Block fragments with suspicious patterns
  - Limit fragments per source IP
  - Fragment rate limiting
  - Complete reassembly before inspection

### System Hardening:
```bash
# Linux fragment protection
echo 30 > /proc/sys/net/ipv4/ipfrag_time
echo 4194304 > /proc/sys/net/ipv4/ipfrag_high_thresh
echo 3145728 > /proc/sys/net/ipv4/ipfrag_low_thresh
```

## ðŸ”§ Attack Tools & Commands
- **Fragroute**: Fragment manipulation tool
- **hping3**: `hping3 --frag target`
- **Scapy**: Custom fragmentation scripts
- **Nemesis**: `nemesis ip -fF -v target`

### Manual Testing:
```bash
# Send fragmented ping
ping -s 2000 target_ip

# Hping3 fragmentation
hping3 -1 --frag -d 1400 target_ip

# Overlapping fragments with Scapy
python3 -c "from scapy.all import *; send(fragment(IP(dst='target')/ICMP()/('X'*2000)))"
```

## ðŸ’¡ Historical Context
- **1997**: Ping of Death widespread
- **Late 1990s**: Teardrop attacks common
- **Windows 95/NT**: Vulnerable to fragment attacks
- **Modern Systems**: Better protection but IoT vulnerable

## ðŸ“Š Fragment Attack Types
| Attack | Method | Impact | Difficulty |
|--------|--------|--------|------------|
| Teardrop | Overlapping fragments | Crash | Low |
| Ping of Death | Oversized reassembly | Crash | Very Low |
| Fragment Flood | Excessive fragments | DoS | Low |
| Bonk/Boink | Invalid offset | Crash | Low |

## ðŸŽ¯ Target Selection
Common targets:
- **Legacy systems** (Windows 95/98/NT)
- **IoT devices** with limited memory
- **Network equipment** (routers, firewalls)
- **Embedded systems** with basic IP stacks

## âš ï¸ Vulnerable Implementations
- **Old IP stacks**: Insufficient bounds checking
- **Embedded systems**: Limited memory for reassembly
- **Default configurations**: Long reassembly timeouts
- **Unpatched systems**: Known fragmentation bugs

## ðŸ” Detection Indicators
- **Excessive fragmented packets**
- **Incomplete fragment sets**
- **Overlapping fragment patterns**
- **High fragment reassembly failures**

### Detection Commands:
```bash
# Monitor fragment statistics
cat /proc/net/snmp | grep Frag

# Check fragment memory usage
cat /proc/net/sockstat | grep frag

# Monitor reassembly failures
netstat -s | grep -i frag

# Real-time fragment monitoring
tcpdump -n 'ip[6:2] & 0x3fff != 0'
```

## ðŸŒ Modern Relevance
- **IPv6**: New fragmentation model
- **IoT Security**: Vulnerable embedded devices
- **Mobile Networks**: Fragment attacks on cellular
- **Cloud Security**: Container/VM fragmentation issues

## ðŸ’¡ Defense Strategy
1. **Fragment Reassembly**: Configure appropriate timeouts
2. **Memory Limits**: Set fragment buffer limits
3. **Rate Limiting**: Control fragment rates per source
4. **Complete Inspection**: Reassemble before security checks
5. **Patch Management**: Keep IP stacks updated

## ðŸ”§ Verification Commands
```bash
# Check fragment settings
cat /proc/sys/net/ipv4/ipfrag_*

# Monitor current fragments
cat /proc/net/ip_frag

# Test fragment handling
hping3 --frag -p 80 -S localhost

# Fragment timeout test
echo 1 > /proc/sys/net/ipv4/ipfrag_time && ping -s 2000 localhost
```

## ðŸ“ˆ Attack Metrics
- **Fragment Rate**: 100-10,000 fragments/sec
- **Memory Consumption**: 64KB per fragment set
- **Reassembly Timeout**: 3-60 seconds default
- **Success Rate**: High against unprotected systems

## ðŸ”„ IPv6 Considerations
- **Different Fragmentation**: Only at source
- **Fragment Header**: Extension header format
- **New Attacks**: IPv6-specific fragment issues
- **Dual Stack**: Both IPv4/IPv6 vulnerabilities
